<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å°‹å¯¶çµäºº</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            color: white;
        }

        /* éŠæˆ²è³‡è¨Šé¢æ¿ */
        #game-hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 10px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px black;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .label {
            font-size: 12px;
            color: #ccc;
        }

        .value {
            font-size: 24px;
            font-weight: bold;
            color: #ffeb3b;
        }

        #target-display {
            font-size: 28px;
            color: #00ff9d;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #00ff9d;
        }

        /* è¦–è¨Šå®¹å™¨ */
        #cam-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover; /* è®“ç•«é¢å¡«æ»¿æ‰‹æ©Ÿè¢å¹• */
        }

        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* UI æŒ‰éˆ•èˆ‡é®ç½© */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.5s;
        }

        #overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        button {
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(45deg, #ff00cc, #3333ff);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 0, 204, 0.5);
            margin-top: 20px;
            transition: transform 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        /* æˆåŠŸæ™‚çš„å‹•ç•«æ•ˆæœ */
        @keyframes flashSuccess {
            0% { box-shadow: inset 0 0 0 0 rgba(0, 255, 0, 0); }
            50% { box-shadow: inset 0 0 100px 50px rgba(0, 255, 0, 0.8); }
            100% { box-shadow: inset 0 0 0 0 rgba(0, 255, 0, 0); }
        }

        .success-anim {
            animation: flashSuccess 0.5s ease-out;
        }

        #message-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
            font-size: 40px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px #00ff00;
            display: none;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="game-hud">
        <div class="hud-item">
            <span class="label">åˆ†æ•¸</span>
            <span class="value" id="score">0</span>
        </div>
        <div class="hud-item">
            <div id="target-display">?</div>
            <span class="label">è«‹å°‹æ‰¾é€™å€‹ç‰©å“</span>
        </div>
        <div class="hud-item">
            <span class="label">æ™‚é–“</span>
            <span class="value" id="timer">0</span>
        </div>
    </div>

    <div id="message-area">æ‰¾åˆ°äº†ï¼âœ¨</div>

    <div id="cam-container">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="overlay">
        <h1 style="font-size: 40px; margin-bottom: 10px;">ğŸ” å°‹å¯¶çµäºº</h1>
        <p id="status-text" style="color:#aaa; margin-bottom: 30px;">æº–å‚™å¥½ä½ çš„ç›¸æ©Ÿäº†å—ï¼Ÿ</p>
        <button id="start-btn" onclick="initGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        const statusText = document.getElementById('status-text');
        const startBtn = document.getElementById('start-btn');
        const targetDisplay = document.getElementById('target-display');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const msgArea = document.getElementById('message-area');
        const camContainer = document.getElementById('cam-container');

        let model = null;
        let isDetecting = false;
        let currentTarget = null;
        let score = 0;
        let startTime = 0;
        let timerInterval = null;
        let cooldown = false; // å†·å»æ™‚é–“ï¼Œé¿å…é€£çºŒåµæ¸¬

        // é©åˆå®¤å…§å°‹å¯¶çš„ç‰©å“æ¸…å–® (COCO-SSD é¡åˆ¥ : ä¸­æ–‡åç¨±)
        const SCAVENGER_ITEMS = [
            { id: 'cup', name: 'æ¯å­' },
            { id: 'bottle', name: 'å¯¶ç‰¹ç“¶/æ°´å£º' },
            { id: 'cell phone', name: 'æ‰‹æ©Ÿ' },
            { id: 'keyboard', name: 'éµç›¤' },
            { id: 'mouse', name: 'æ»‘é¼ ' },
            { id: 'remote', name: 'é™æ§å™¨' },
            { id: 'book', name: 'æ›¸æœ¬' },
            { id: 'chair', name: 'æ¤…å­' },
            { id: 'potted plant', name: 'ç›†æ ½' },
            { id: 'laptop', name: 'ç­†é›»' },
            { id: 'clock', name: 'æ™‚é˜' },
            { id: 'scissors', name: 'å‰ªåˆ€' },
            { id: 'backpack', name: 'èƒŒåŒ…' },
            { id: 'person', name: 'äººé¡' }, // é€åˆ†é¡Œ
            { id: 'spoon', name: 'æ¹¯åŒ™' }
        ];

        // 1. åˆå§‹åŒ–èˆ‡è¼‰å…¥æ¨¡å‹
        async function initGame() {
            startBtn.disabled = true;
            startBtn.innerText = "æ¨¡å‹è¼‰å…¥ä¸­ (éœ€ç¶²è·¯)...";
            statusText.innerText = "ç¬¬ä¸€æ¬¡ä¸‹è¼‰ç´„éœ€ 10-30 ç§’ï¼Œä¹‹å¾Œå¯é›¢ç·šã€‚";

            try {
                if (!model) {
                    model = await cocoSsd.load();
                }
                
                startCamera();
            } catch (error) {
                console.error(error);
                statusText.innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚";
                startBtn.disabled = false;
                startBtn.innerText = "é‡è©¦";
            }
        }

        // 2. å•Ÿå‹•ç›¸æ©Ÿ
        async function startCamera() {
            statusText.innerText = "è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...";
            
            const constraints = {
                audio: false,
                video: {
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadeddata = () => {
                    video.play();
                    resizeCanvas();
                    startGameLoop();
                };
            } catch (err) {
                statusText.innerText = "ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼š" + err.message;
                startBtn.disabled = false;
                startBtn.innerText = "é‡è©¦";
            }
        }

        // 3. éŠæˆ²é–‹å§‹
        function startGameLoop() {
            overlay.classList.add('hidden');
            isDetecting = true;
            score = 0;
            scoreDisplay.innerText = score;
            
            // é–‹å§‹è¨ˆæ™‚
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const seconds = Math.floor((Date.now() - startTime) / 1000);
                timerDisplay.innerText = seconds;
            }, 1000);

            nextTarget();
            predictLoop();
        }

        // éš¨æ©Ÿé¸æ“‡ä¸‹ä¸€å€‹ç›®æ¨™
        function nextTarget() {
            const randomIndex = Math.floor(Math.random() * SCAVENGER_ITEMS.length);
            currentTarget = SCAVENGER_ITEMS[randomIndex];
            targetDisplay.innerText = currentTarget.name;
            targetDisplay.style.animation = "none";
            targetDisplay.offsetHeight; /* trigger reflow */
            targetDisplay.style.animation = "popIn 0.3s";
        }

        // 4. AI åµæ¸¬è¿´åœˆ
        async function predictLoop() {
            if (!isDetecting) return;

            // å–å¾—é æ¸¬çµæœ
            const predictions = await model.detect(video);

            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æª¢æŸ¥æ˜¯å¦æ‰¾åˆ°ç›®æ¨™
            let foundTarget = false;

            predictions.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;
                const text = prediction.class;
                
                // ç•«æ¡†æ¡†é‚è¼¯
                let color = '#00FFFF'; // é è¨­é’è‰² (éç›®æ¨™)
                let lineWidth = 2;

                // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰ç›®æ¨™
                if (!cooldown && text === currentTarget.id) {
                    color = '#00FF00'; // ç›®æ¨™è®Šæˆç¶ è‰²
                    lineWidth = 6;
                    foundTarget = true;
                }

                // ç¹ªè£½
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.strokeRect(x, y, width, height);

                // æ¨™ç±¤èƒŒæ™¯
                ctx.fillStyle = color;
                const label = text === currentTarget.id ? currentTarget.name : text; // ç›®æ¨™é¡¯ç¤ºä¸­æ–‡ï¼Œå…¶ä»–é¡¯ç¤ºè‹±æ–‡
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(x, y > 20 ? y - 25 : 0, textWidth + 10, 25);

                // æ¨™ç±¤æ–‡å­—
                ctx.fillStyle = '#000';
                ctx.font = 'bold 18px Arial';
                ctx.fillText(label, x + 5, y > 20 ? y - 7 : 18);
            });

            // å¦‚æœæ‰¾åˆ°ç›®æ¨™ä¸”ä¸åœ¨å†·å»æ™‚é–“
            if (foundTarget) {
                handleSuccess();
            }

            requestAnimationFrame(predictLoop);
        }

        // æˆåŠŸæ‰¾åˆ°ç‰©å“çš„è™•ç†
        function handleSuccess() {
            cooldown = true;
            score++;
            scoreDisplay.innerText = score;

            // è¦–è¦ºç‰¹æ•ˆ
            camContainer.classList.add('success-anim'); // è¢å¹•é‚Šæ¡†é–ƒçˆ
            msgArea.innerText = `æ‰¾åˆ° ${currentTarget.name} äº†ï¼ +1`;
            msgArea.style.display = 'block';

            // éœ‡å‹•å›é¥‹ (å¦‚æœè£ç½®æ”¯æ´)
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // å»¶é²å¾Œé€²å…¥ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                camContainer.classList.remove('success-anim');
                msgArea.style.display = 'none';
                cooldown = false;
                nextTarget();
            }, 2000); // 2ç§’å¾Œæ›ä¸‹ä¸€é¡Œ
        }

        // è¦–çª—èª¿æ•´è™•ç†
        function resizeCanvas() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
        }
        
        window.addEventListener('resize', () => {
             if(video.readyState >= 2) resizeCanvas();
        });

    </script>
</body>
</html>
